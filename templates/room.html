{% extends "base.html" %}

{% block title %}AI Escape Room ‚Äî {{ theme_data.name }}{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col"
     style="--accent: {{ theme_data.gradient_to }}; --accent-dim: {{ theme_data.gradient_from }}; --accent-alpha: {{ theme_data.gradient_to }}33;">

    <!-- Top bar -->
    <header class="sticky top-0 z-50 border-b border-white/[0.06] bg-[#09090b]/80 backdrop-blur-xl">
        <div class="max-w-3xl mx-auto flex items-center justify-between gap-6 px-4 py-3">
            <!-- Timer -->
            <div class="flex items-center gap-2.5">
                <div class="w-9 h-9 rounded-xl bg-white/[0.04] border border-white/[0.06] flex items-center justify-center text-base">‚è±Ô∏è</div>
                <div>
                    <div id="timer" class="font-display text-xl font-bold tabular-nums tracking-tight" data-remaining="{{ remaining_seconds }}">--:--</div>
                    <div class="text-[10px] text-gray-600 uppercase tracking-widest">remaining</div>
                </div>
            </div>

            <!-- Progress -->
            <div class="flex-1 max-w-[200px]">
                <div class="flex justify-between text-[10px] text-gray-500 mb-1.5 uppercase tracking-widest">
                    <span>Puzzle <span id="puzzle-num">{{ puzzle_number }}</span>/{{ total_puzzles }}</span>
                    <span id="progress-pct">{{ ((puzzle_number - 1) / total_puzzles * 100) | int }}%</span>
                </div>
                <div class="h-1 bg-white/[0.06] rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full rounded-full transition-all duration-700 ease-out"
                         style="width: {{ ((puzzle_number - 1) / total_puzzles * 100) | int }}%; background: var(--accent);"></div>
                </div>
            </div>

            <!-- Score -->
            <div class="text-right">
                <div id="score" class="font-display text-xl font-bold" style="color: var(--accent);">{{ score }}</div>
                <div class="text-[10px] text-gray-600 uppercase tracking-widest">score</div>
            </div>
        </div>
    </header>

    <!-- Game area -->
    <div class="flex-1 flex flex-col items-center px-4 py-8 max-w-2xl mx-auto w-full">

        <!-- Narrative -->
        <div id="narrative" class="w-full mb-6 animate-fade-in">
            <p id="narrative-text" class="text-gray-400 italic text-center text-[15px] leading-relaxed px-6 py-4 rounded-2xl bg-white/[0.02] border border-white/[0.04]">
                {{ puzzle.narrative_text if puzzle else '' }}
            </p>
        </div>

        <!-- Puzzle card -->
        <div id="puzzle-card" class="w-full rounded-2xl border border-white/[0.08] bg-white/[0.02] backdrop-blur-sm p-8 mb-6 animate-scale-in transition-all duration-500"
             style="box-shadow: 0 0 60px -20px var(--accent-alpha);">

            <div class="flex items-center gap-2.5 mb-5">
                <span class="text-[11px] font-semibold uppercase tracking-widest px-3 py-1 rounded-full border"
                      style="border-color: var(--accent-alpha); color: var(--accent); background: var(--accent-alpha);">
                    <span id="puzzle-type">{{ puzzle.puzzle_type if puzzle else 'riddle' }}</span>
                </span>
                <span class="text-[11px] text-gray-600 uppercase tracking-widest">Puzzle #<span id="puzzle-number-badge">{{ puzzle_number }}</span></span>
            </div>

            <p id="puzzle-question" class="font-display text-xl font-medium leading-relaxed text-gray-100 mb-8">
                {{ puzzle.question if puzzle else 'Loading puzzle...' }}
            </p>

            <!-- Answer input -->
            <div class="flex gap-3">
                <input type="text" id="answer-input" placeholder="Type your answer..."
                    autocomplete="off"
                    class="flex-1 bg-white/[0.04] border border-white/[0.08] rounded-xl px-4 py-3 text-base font-medium focus:outline-none focus:border-white/20 transition-all placeholder-gray-600"
                    onkeydown="if(event.key==='Enter') submitAnswer()">
                <button id="submit-btn" onclick="submitAnswer()"
                    class="px-6 py-3 rounded-xl font-display font-semibold text-base text-[#09090b] transition-all duration-200 hover:brightness-110 active:scale-95"
                    style="background: var(--accent);">
                    Submit
                </button>
            </div>

            <!-- Feedback -->
            <div id="feedback" class="hidden mt-5 p-4 rounded-xl text-sm border animate-fade-in"></div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 w-full mb-6">
            <button onclick="requestHint()" id="hint-btn"
                class="flex-1 rounded-xl px-4 py-3 text-sm font-medium bg-white/[0.03] border border-white/[0.06] hover:bg-white/[0.06] hover:border-white/[0.1] transition-all duration-300 flex items-center justify-center gap-2">
                <span>üí°</span>
                <span>Get Hint</span>
                <span class="text-gray-600 text-xs ml-1">-60s</span>
            </button>
            <button onclick="toggleImageUpload()" id="upload-btn"
                class="flex-1 rounded-xl px-4 py-3 text-sm font-medium bg-white/[0.03] border border-white/[0.06] hover:bg-white/[0.06] hover:border-white/[0.1] transition-all duration-300 flex items-center justify-center gap-2">
                <span>üì∑</span>
                <span>Upload Clue</span>
            </button>
        </div>

        <!-- Image upload panel -->
        <div id="image-upload-panel" class="hidden w-full mb-6 animate-slide-in-right">
            <div class="rounded-2xl border border-white/[0.06] bg-white/[0.02] p-6">
                <p class="text-gray-500 text-sm mb-3">Upload an image and Gemini 3 will create a visual puzzle from it.</p>
                <div class="flex gap-3">
                    <input type="file" id="image-input" accept="image/*"
                        class="flex-1 text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-white/[0.06] file:text-gray-300 hover:file:bg-white/10 file:transition-colors">
                    <button onclick="uploadClue()"
                        class="px-5 py-2 rounded-lg font-semibold text-sm text-[#09090b] transition-all hover:brightness-110"
                        style="background: var(--accent);">
                        Analyze
                    </button>
                </div>
            </div>
        </div>

        <!-- Hint panel -->
        <div id="hint-panel" class="hidden w-full mb-6 animate-slide-in-right">
            <div class="rounded-2xl border border-white/[0.06] bg-white/[0.02] p-6">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-base">üí°</span>
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Hint</span>
                </div>
                <p id="hint-text" class="text-gray-300 leading-relaxed"></p>
                <p id="hint-encouragement" class="text-gray-600 text-sm mt-2 italic"></p>
            </div>
        </div>
    </div>
</div>

<script>
    const TOTAL_PUZZLES = {{ total_puzzles }};
    let remainingSeconds = {{ remaining_seconds }};
    let currentPuzzleNumber = {{ puzzle_number }};
    let currentScore = {{ score }};
    let isSubmitting = false;
</script>
{% endblock %}
