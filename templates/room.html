{% extends "base.html" %}

{% block title %}AI Escape Room ‚Äî {{ theme_data.name }}{% endblock %}

{% block head %}
<style>
    .theme-accent { color: var(--accent-color); }
    .theme-accent-bg { background-color: var(--accent-color); }
    .theme-border { border-color: var(--accent-color); }
    .theme-glow { box-shadow: 0 0 20px var(--accent-color-alpha); }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col theme-{{ theme }}"
     style="--accent-color: {{ {'temple':'#d97706','space':'#06b6d4','haunted':'#a855f7'}[theme] }};
            --accent-color-alpha: {{ {'temple':'rgba(217,119,6,0.3)','space':'rgba(6,182,212,0.3)','haunted':'rgba(168,85,247,0.3)'}[theme] }};">

    <!-- Top bar: timer + progress + score -->
    <header class="sticky top-0 z-50 bg-gray-950/90 backdrop-blur border-b border-gray-800 px-4 py-3">
        <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
            <!-- Timer -->
            <div class="flex items-center gap-2">
                <div id="timer-icon" class="text-2xl">‚è±Ô∏è</div>
                <div>
                    <div id="timer" class="text-2xl font-mono font-bold tabular-nums" data-remaining="{{ remaining_seconds }}">
                        --:--
                    </div>
                    <div class="text-xs text-gray-500">remaining</div>
                </div>
            </div>

            <!-- Progress bar -->
            <div class="flex-1 max-w-xs">
                <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span>Puzzle <span id="puzzle-num">{{ puzzle_number }}</span> / {{ total_puzzles }}</span>
                    <span id="progress-pct">{{ ((puzzle_number - 1) / total_puzzles * 100) | int }}%</span>
                </div>
                <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full rounded-full transition-all duration-700 ease-out"
                         style="width: {{ ((puzzle_number - 1) / total_puzzles * 100) | int }}%; background-color: var(--accent-color);">
                    </div>
                </div>
            </div>

            <!-- Score -->
            <div class="text-right">
                <div id="score" class="text-2xl font-bold" style="color: var(--accent-color);">{{ score }}</div>
                <div class="text-xs text-gray-500">score</div>
            </div>
        </div>
    </header>

    <!-- Main game area -->
    <div class="flex-1 flex flex-col items-center px-4 py-8 max-w-3xl mx-auto w-full">
        <!-- Narrative text -->
        <div id="narrative" class="w-full mb-6 animate-fade-in">
            <div id="narrative-text" class="text-gray-300 italic text-center text-lg leading-relaxed px-4 py-3 rounded-xl bg-gray-900/50 border border-gray-800">
                {{ puzzle.narrative_text if puzzle else '' }}
            </div>
        </div>

        <!-- Puzzle card -->
        <div id="puzzle-card" class="w-full bg-gray-900/80 backdrop-blur border border-gray-800 rounded-2xl p-8 mb-6 animate-fade-in theme-glow">
            <div class="flex items-center gap-2 mb-4">
                <span class="text-xs font-semibold uppercase tracking-widest px-3 py-1 rounded-full"
                      style="background-color: var(--accent-color-alpha); color: var(--accent-color);">
                    <span id="puzzle-type">{{ puzzle.puzzle_type if puzzle else 'riddle' }}</span>
                </span>
                <span class="text-xs text-gray-500">Puzzle #<span id="puzzle-number-badge">{{ puzzle_number }}</span></span>
            </div>

            <p id="puzzle-question" class="text-xl font-medium leading-relaxed mb-6">
                {{ puzzle.question if puzzle else 'Loading puzzle...' }}
            </p>

            <!-- Answer input -->
            <div class="flex gap-3">
                <input
                    type="text"
                    id="answer-input"
                    placeholder="Type your answer..."
                    autocomplete="off"
                    class="flex-1 bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-lg focus:outline-none focus:border-gray-500 focus:ring-1 focus:ring-gray-500 transition-colors placeholder-gray-600"
                    onkeydown="if(event.key==='Enter') submitAnswer()"
                >
                <button
                    id="submit-btn"
                    onclick="submitAnswer()"
                    class="px-6 py-3 rounded-xl font-semibold text-lg transition-all duration-200 hover:scale-105 active:scale-95"
                    style="background-color: var(--accent-color); color: #111827;"
                >
                    Submit
                </button>
            </div>

            <!-- Feedback area -->
            <div id="feedback" class="hidden mt-4 p-4 rounded-xl text-sm animate-fade-in"></div>
        </div>

        <!-- Action buttons -->
        <div class="flex gap-4 w-full mb-6">
            <button
                onclick="requestHint()"
                id="hint-btn"
                class="flex-1 bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm font-medium hover:bg-gray-700 transition-all duration-200 flex items-center justify-center gap-2"
            >
                <span>üí°</span>
                <span>Get Hint</span>
                <span class="text-gray-500 text-xs">(-60s)</span>
            </button>
            <button
                onclick="toggleImageUpload()"
                id="upload-btn"
                class="flex-1 bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm font-medium hover:bg-gray-700 transition-all duration-200 flex items-center justify-center gap-2"
            >
                <span>üì∑</span>
                <span>Upload Clue</span>
            </button>
        </div>

        <!-- Image upload panel (hidden by default) -->
        <div id="image-upload-panel" class="hidden w-full mb-6 animate-slide-in">
            <div class="bg-gray-900/80 border border-gray-800 rounded-2xl p-6">
                <p class="text-gray-400 text-sm mb-3">Upload an image and Gemini 3 will create a visual puzzle from it.</p>
                <div class="flex gap-3">
                    <input
                        type="file"
                        id="image-input"
                        accept="image/*"
                        class="flex-1 text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-gray-200 hover:file:bg-gray-600"
                    >
                    <button
                        onclick="uploadClue()"
                        class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 hover:scale-105"
                        style="background-color: var(--accent-color); color: #111827;"
                    >
                        Analyze
                    </button>
                </div>
            </div>
        </div>

        <!-- Hint display -->
        <div id="hint-panel" class="hidden w-full mb-6 animate-slide-in">
            <div class="bg-gray-900/80 border border-gray-800 rounded-2xl p-6">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg">üí°</span>
                    <span class="text-sm font-semibold text-gray-300">Hint</span>
                </div>
                <p id="hint-text" class="text-gray-300"></p>
                <p id="hint-encouragement" class="text-gray-500 text-sm mt-2 italic"></p>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize game state from server data
    const TOTAL_PUZZLES = {{ total_puzzles }};
    let remainingSeconds = {{ remaining_seconds }};
    let currentPuzzleNumber = {{ puzzle_number }};
    let currentScore = {{ score }};
    let isSubmitting = false;
</script>
{% endblock %}
