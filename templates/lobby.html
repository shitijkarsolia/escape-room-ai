{% extends "base.html" %}

{% block title %}AI Escape Room â€” Choose Your Fate{% endblock %}

{% block content %}
<div class="min-h-screen px-4 py-16 max-w-6xl mx-auto">

    <!-- Hero -->
    <div class="text-center mb-16 animate-slide-up">
        <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-medium text-gray-400 mb-6 backdrop-blur-sm">
            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
            Powered by Groq
        </div>
        <h1 class="font-display text-6xl md:text-7xl font-bold tracking-tight mb-4">
            <span class="bg-gradient-to-r from-white via-gray-200 to-gray-400 bg-clip-text text-transparent">
                AI Escape Room
            </span>
        </h1>
        <p class="text-gray-500 text-lg max-w-lg mx-auto leading-relaxed">
            Every puzzle is uniquely generated. Every playthrough is different.<br>
            <span class="text-gray-400">Can you escape before time runs out?</span>
        </p>
    </div>

    <!-- TV Shows & Movies Section -->
    <div class="mb-14 animate-fade-in">
        <div class="flex items-center gap-3 mb-6">
            <h2 class="font-display text-xl font-semibold text-white">TV Shows & Movies</h2>
            <div class="flex-1 h-px bg-gradient-to-r from-white/10 to-transparent"></div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for key, theme in themes.items() %}
            {% if theme.category == 'tvshow' %}
            <button onclick="selectTheme('{{ key }}')" data-theme="{{ key }}"
                class="theme-card group relative overflow-hidden rounded-2xl border border-white/[0.06] bg-white/[0.02] text-left transition-all duration-500 hover:border-white/[0.12] focus:outline-none focus:ring-2 focus:ring-white/20"
                style="min-height: 220px;">
                <!-- Background image -->
                {% if theme.image %}
                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110"
                     style="background-image: url('{{ theme.image }}');"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-[#09090b] via-[#09090b]/80 to-[#09090b]/40 group-hover:via-[#09090b]/70 group-hover:to-[#09090b]/30 transition-all duration-500"></div>
                {% else %}
                <div class="absolute -top-20 -right-20 w-40 h-40 rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-700 blur-3xl"
                     style="background: {{ theme.gradient_to }};"></div>
                {% endif %}
                <!-- Content -->
                <div class="relative z-10 p-6 flex flex-col justify-end h-full">
                    <span class="text-4xl mb-3 block filter drop-shadow-lg">{{ theme.icon }}</span>
                    <h3 class="font-display text-lg font-semibold text-white mb-1 drop-shadow-md">
                        {{ theme.name }}
                    </h3>
                    <p class="text-gray-300 text-sm leading-relaxed drop-shadow-sm">
                        {{ theme.tagline }}
                    </p>
                </div>
                <!-- Bottom accent -->
                <div class="absolute bottom-0 left-0 right-0 h-[2px] transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left z-10"
                     style="background: linear-gradient(90deg, {{ theme.gradient_from }}, {{ theme.gradient_to }});"></div>
            </button>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Make Your Own Section -->
    <div class="mb-14 animate-fade-in-delay">
        <div class="flex items-center gap-3 mb-6">
            <h2 class="font-display text-xl font-semibold text-white">Make Your Own</h2>
            <div class="flex-1 h-px bg-gradient-to-r from-white/10 to-transparent"></div>
            <span class="text-xs font-medium text-gray-500 bg-white/5 px-3 py-1 rounded-full border border-white/10">MULTIMODAL</span>
        </div>
        <div class="rounded-2xl border border-white/[0.06] bg-white/[0.02] p-8">
            <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-3xl">ðŸ“·</span>
                        <h3 class="font-display text-lg font-semibold text-white">Upload an Image</h3>
                    </div>
                    <p class="text-gray-500 text-sm leading-relaxed mb-4">
                        Upload any photo and AI will analyze it to create a full escape room with 5 unique visual puzzles based on what it sees. Works with anything â€” a room, a drawing, a meme, a screenshot.
                    </p>
                    <div class="flex gap-3 items-center">
                        <input type="file" id="custom-image-input" accept="image/*"
                            class="flex-1 text-sm text-gray-400 file:mr-4 file:py-2.5 file:px-5 file:rounded-xl file:border-0 file:text-sm file:font-medium file:bg-white/[0.06] file:text-gray-300 hover:file:bg-white/10 file:transition-colors file:cursor-pointer">
                        <button onclick="startCustomGame()"
                            class="px-6 py-2.5 rounded-xl font-display font-semibold text-sm text-[#09090b] bg-indigo-500 hover:brightness-110 active:scale-95 transition-all whitespace-nowrap">
                            Generate Room
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Difficulty selector modal -->
    <div id="difficulty-modal" class="hidden fixed inset-0 z-50 bg-[#09090b]/90 backdrop-blur-md flex items-center justify-center px-4">
        <div class="w-full max-w-md rounded-2xl border border-white/[0.08] bg-[#09090b] p-8 animate-scale-in">
            <h3 class="font-display text-2xl font-bold text-white mb-2 text-center">Choose Difficulty</h3>
            <p class="text-gray-500 text-sm text-center mb-6" id="diff-theme-name"></p>
            <div class="grid grid-cols-3 gap-3 mb-6" id="diff-buttons">
                <button onclick="pickDifficulty(1)"
                    class="diff-btn rounded-xl border border-white/[0.06] bg-white/[0.02] p-4 text-center hover:bg-white/[0.06] hover:border-white/[0.12] transition-all focus:outline-none focus:ring-2 focus:ring-white/20">
                    <div class="text-2xl mb-1">ðŸŸ¢</div>
                    <div class="font-display font-semibold text-white text-sm">Easy</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">Casual fun</div>
                </button>
                <button onclick="pickDifficulty(3)"
                    class="diff-btn rounded-xl border border-white/[0.06] bg-white/[0.02] p-4 text-center hover:bg-white/[0.06] hover:border-white/[0.12] transition-all focus:outline-none focus:ring-2 focus:ring-white/20">
                    <div class="text-2xl mb-1">ðŸŸ¡</div>
                    <div class="font-display font-semibold text-white text-sm">Medium</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">Balanced</div>
                </button>
                <button onclick="pickDifficulty(5)"
                    class="diff-btn rounded-xl border border-white/[0.06] bg-white/[0.02] p-4 text-center hover:bg-white/[0.06] hover:border-white/[0.12] transition-all focus:outline-none focus:ring-2 focus:ring-white/20">
                    <div class="text-2xl mb-1">ðŸ”´</div>
                    <div class="font-display font-semibold text-white text-sm">Hard</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">True fan</div>
                </button>
            </div>
            <button onclick="closeDiffModal()" class="w-full text-center text-gray-600 text-sm hover:text-gray-400 transition-colors">Cancel</button>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading" class="hidden fixed inset-0 z-50 bg-[#09090b]/90 backdrop-blur-md flex flex-col items-center justify-center">
        <div class="relative mb-6">
            <div class="w-14 h-14 rounded-full border-2 border-white/10 border-t-white/60 animate-spin"></div>
        </div>
        <p class="text-gray-300 text-lg font-display font-medium" id="loading-text">Generating your escape room...</p>
        <p class="text-gray-600 text-sm mt-2">Groq is crafting unique puzzles at lightning speed</p>
    </div>

    <!-- Footer -->
    <div class="text-center text-gray-600 text-xs mt-8 space-y-1">
        <p>5 puzzles &middot; 15 minute timer &middot; Hints cost 60 seconds</p>
        <p class="text-gray-700">Powered by Groq LPU Inference Engine</p>
    </div>
</div>

<script>
let selectedTheme = null;

// Theme names for the difficulty modal
const THEME_NAMES = {
    {% for key, theme in themes.items() %}
    '{{ key }}': '{{ theme.name }}',
    {% endfor %}
};

function selectTheme(theme) {
    selectedTheme = theme;
    document.getElementById('diff-theme-name').textContent = THEME_NAMES[theme] || theme;
    document.getElementById('difficulty-modal').classList.remove('hidden');
}

function closeDiffModal() {
    document.getElementById('difficulty-modal').classList.add('hidden');
    selectedTheme = null;
}

async function pickDifficulty(level) {
    if (!selectedTheme) return;
    document.getElementById('difficulty-modal').classList.add('hidden');

    const cards = document.querySelectorAll('.theme-card');
    cards.forEach(c => {
        c.disabled = true;
        c.style.pointerEvents = 'none';
        if (c.dataset.theme !== selectedTheme) {
            c.style.opacity = '0.15';
            c.style.transform = 'scale(0.97)';
        } else {
            c.style.borderColor = 'rgba(255,255,255,0.2)';
        }
    });
    showLoading();

    try {
        const resp = await fetch('/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ theme: selectedTheme, difficulty: level }),
        });
        const data = await resp.json();
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert(data.error || 'Failed to start game. The AI might be busy â€” try again.');
            window.location.reload();
        }
    } catch (err) {
        alert('Connection error. Please try again.');
        window.location.reload();
    }
}

async function startCustomGame() {
    const fileInput = document.getElementById('custom-image-input');
    const file = fileInput.files[0];
    if (!file) {
        alert('Please select an image first.');
        return;
    }
    showLoading();

    const formData = new FormData();
    formData.append('image', file);

    try {
        const resp = await fetch('/start-custom', {
            method: 'POST',
            body: formData,
        });
        const data = await resp.json();
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert(data.error || 'Failed to create custom room. Try again.');
            window.location.reload();
        }
    } catch (err) {
        alert('Connection error. Please try again.');
        window.location.reload();
    }
}

function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
    const messages = [
        'Generating your escape room...',
        'Crafting puzzles with Groq...',
        'Building the first challenge...',
        'Almost ready...'
    ];
    let msgIdx = 0;
    setInterval(() => {
        msgIdx = (msgIdx + 1) % messages.length;
        document.getElementById('loading-text').textContent = messages[msgIdx];
    }, 2500);
}
</script>
{% endblock %}
